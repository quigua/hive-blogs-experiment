---
// src/pages/index.astro
const FUNCTIONS_BASE_URL = 'https://dreamy-baklava-d17cb6.netlify.app/.netlify/functions';
const USERNAME_TO_FETCH = 'quigua';
const POSTS_PER_PAGE = 20;

let initialPosts = [];
let hasMorePosts = false;
let nextStartAuthor = null;
let nextStartPermlink = null;

try {
    const response = await fetch(`${FUNCTIONS_BASE_URL}/get-user-posts?username=${USERNAME_TO_FETCH}&limit=${POSTS_PER_PAGE}`);  
    const data = await response.json();

    if (data.error) {
        console.error("Error al cargar posts iniciales (server-side):", data.error, data.details);
    } else {
        initialPosts = data.posts;
        hasMorePosts = data.hasMore;
        nextStartAuthor = data.nextPage?.startAuthor || null;
        // *** CORRECCIÓN CRÍTICA AQUÍ: nextStartPermlink debería ser data.nextPage?.permlink ***
        nextStartPermlink = data.nextPage?.permlink || null;
        console.log("Posts iniciales cargados (server-side):", initialPosts.length, "Has more:", hasMorePosts);
        console.log("Next page info (server-side):", nextStartAuthor, nextStartPermlink);
    }
} catch (error) {
    console.error("Error al conectar con la función Netlify para posts iniciales (server-side):", error);
}
---
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Blog de Hive - Astro</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333;}
        h1 { color: #007bff; text-align: center;}
        #posts-list { margin: 20px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-width: 800px;}
        #posts-list h2 { margin-top: 0; color: #555;}
        #posts-container { list-style: none; padding: 0;}
        #posts-container li { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;}
        #posts-container li:last-child { border-bottom: none;}
        .post-title {
            text-decoration: none;
            color: #007bff;
            font-weight: bold;
            font-size: 1.2em;
            cursor: pointer; /* Indicar que es clickeable */
        }
        .post-title:hover { text-decoration: underline;}
        .post-meta { font-size: 0.9em; color: #777;}
        .load-more-button {
            display: block;
            width: fit-content;
            margin: 20px auto 0;
            padding: 10px 20px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
        }
        .load-more-button:hover { background-color: #218838;}
        /* Ocultar el detalle del post por defecto en esta página, ya que tendrá su propia página */
        #post-detail { display: none; }
    </style>
    <script>import { marked } from 'marked';// ... tu código que usa marked.parse()</script>
    
</head>
<body>

    <h1>Posts de Hive de @{USERNAME_TO_FETCH}</h1>

    <div id="posts-list">
        <h2>Últimos Posts</h2>
        <ul id="posts-container">
            {initialPosts.length === 0 ? (
                <li>No se encontraron posts o hubo un error al cargar.</li>
            ) : (
                initialPosts.map(post => (
                    <li>
                        <a href={`/post-detail?author=\{post\.author\}&permlink\={post.permlink}`} class="post-title">
                            {post.title}
                        </a>
                        <p class="post-meta">Publicado por {post.author} el {new Date(post.created).toLocaleDateString()}</p>
                    </li>
                ))
            )}
        </ul>
        {hasMorePosts && <button id="load-more-button" class="load-more-button">Cargar más</button>}
    </div>

    <script is:inline>
    const FUNCTIONS_BASE_URL_CLIENT = 'https://dreamy-baklava-d17cb6.netlify.app/.netlify/functions';
    const USERNAME_TO_FETCH_CLIENT = 'quigua';
    const POSTS_PER_PAGE_CLIENT = 20;

    // Inyectamos las variables desde el frontmatter directamente en el script
    // Usamos una variable global para el state de paginación para facilitar el acceso
    window.paginationState = {
        currentStartAuthor: {JSON.stringify(nextStartAuthor)},
        currentStartPermlink: {JSON.stringify(nextStartPermlink)},
        hasMorePosts: {JSON.stringify(hasMorePosts)}
    };

    const postsContainerClient = document.getElementById('posts-container');
    const loadMoreButtonClient = document.getElementById('load-more-button');

    // Función para cargar más posts desde el cliente
    async function fetchMorePosts() {
        loadMoreButtonClient.textContent = 'Cargando...';
        loadMoreButtonClient.disabled = true;

        const { currentStartAuthor, currentStartPermlink } = window.paginationState;

        let url = `${FUNCTIONS_BASE_URL}/get-user-posts?username=${USERNAME_TO_FETCH}&limit=${POSTS_PER_PAGE}`;
        if (currentStartAuthor && currentStartPermlink) {
            url += `&startAuthor=\{currentStartAuthor\}&startPermlink\={currentStartPermlink}`;
        }

        try {
            console.log("Intentando fetch de más posts desde el cliente:", url); // LOG CLAVE
            const response = await fetch(url);
            const data = await response.json();
            console.log("Respuesta de fetch (cliente):", data); // LOG CLAVE

            if (data.error) {
                console.error("Error al cargar más posts (client-side):", data.error, data.details);
                postsContainerClient.innerHTML += `<li>Error al cargar más posts: ${data.error}</li>`;
                loadMoreButtonClient.textContent = 'Error al cargar';
                loadMoreButtonClient.disabled = false;
                return;
            }

            if (data.posts.length === 0) {
                loadMoreButtonClient.style.display = 'none';
                postsContainerClient.innerHTML += '<li>No hay más posts para cargar.</li>';
                return;
            }

            data.posts.forEach(post => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = `/post-detail?author=\{post\.author\}&permlink\={post.permlink}`;
                a.className = 'post-title';
                a.textContent = post.title;

                const meta = document.createElement('p');
                meta.className = 'post-meta';
                meta.textContent = `Publicado por ${post.author} el ${new Date(post.created).toLocaleDateString()}`;

                li.appendChild(a);
                li.appendChild(meta);
                postsContainerClient.appendChild(li);
            });

            window.paginationState.hasMorePosts = data.hasMore;
            if (data.hasMore) {
                window.paginationState.currentStartAuthor = data.nextPage.startAuthor;
                // *** CORRECCIÓN CRÍTICA AQUÍ: data.nextPage.permlink ***
                window.paginationState.currentStartPermlink = data.nextPage.permlink;
                loadMoreButtonClient.textContent = 'Cargar más';
                loadMoreButtonClient.disabled = false;
            } else {
                loadMoreButtonClient.style.display = 'none';
                postsContainerClient.innerHTML += '<li>Todos los posts han sido cargados.</li>';
            }

        } catch (error) {
            console.error("Error fetching more posts (client-side):", error);
            postsContainerClient.innerHTML += `<li>Error de conexión al cargar más posts: ${error.message}</li>`;
            loadMoreButtonClient.textContent = 'Error de conexión';
            loadMoreButtonClient.disabled = false;
        }
    }

    // Asignar el event listener al botón "Cargar más"
    // Y ocultarlo si no hay más posts desde la carga inicial del servidor
    document.addEventListener('DOMContentLoaded', () => {
        if (loadMoreButtonClient) {
            if (!window.paginationState.hasMorePosts) {
                loadMoreButtonClient.style.display = 'none';
            }
            loadMoreButtonClient.addEventListener('click', fetchMorePosts);
        }
    });
</script>
</body>
</html>
    </script>
</body>
</html>